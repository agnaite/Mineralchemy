{% extends 'base.html' %}
{% block content %}

Results:
<p id="count">0</p>

<div id="Minfind"></div>
<div id="Etsy"></div>
<div id="eBay"></div>

<script src="https://code.jquery.com/jquery.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script> 
<script>
	function getMinfindResults(evt){
		$.ajax(
			{
				type: 'GET',
				url: '/scrape_minfind', 
				data: {
					"keywords": "{{ keywords }}",
					"min_price": {{ min_price }},
					"max_price": {{ max_price }}
				},
				dataType: 'JSON',
				success: function(response){

					var count = parseInt($('#count').text().trim(), 10);
					var new_count = count + response.minfindNumResults;
					$('#count').text(new_count);

					if (response.minfindNumResults > 0) {
						$('#Minfind').append($("<h1></h1>").text("Minfind Results:"));

						for (i = 0; i < response.minfindListings.length; i++) {
							var listing = response.minfindListings[i];

							var title = $("<p></p>").text(listing.title);
							var price = $("<p></p>").text(listing.price);
							if (listing.description != []) {
								description = $("<p></p>").text(listing.description);
							};
							var link = $("<a></a>").attr("href", listing.url).text("URL");

							$('#Minfind').append(title, price, description, link);
						};
					} else {
						$('#Minfind').append($("<h1></h1>").text("No results found on Minfind"));
					};
				}
			}
		);
	}

	function getEtsyResults(evt){
		$.ajax(
			{
				type: 'GET',
				url: '/search_etsy', 
				data: {
					"keywords": "{{ keywords }}",
					"min_price": {{ min_price }},
					"max_price": {{ max_price }}
				},
				dataType: 'JSON',
				success: function(response){

					var count = parseInt($('#count').text().trim(), 10);
					var new_count = count + response.etsyNumResults;
					$('#count').text(new_count);

					if (response.etsyNumResults > 0) {
						$('#Etsy').append($("<h1></h1>").text("Etsy Results:"));

						for (i = 0; i < response.etsyListings.length; i++) {
							var listing = response.etsyListings[i];

							var title = $("<p></p>").text(listing.title);
							var price = $("<p></p>").text(listing.price);
							if (listing.description != []) {
								description = $("<p></p>").text(listing.description);
							};
							var link = $("<a></a>").attr("href", listing.url).text("URL");

							$('#Etsy').append(title, price, description, link);
						};
					} else {
						$('#Etsy').append($("<h1></h1>").text("No results found on Etsy"));
					};
				}
			}
		);
	}

	function getEbayResults(evt){
		$.ajax(
			{
				type: 'GET',
				url: '/search_ebay', 
				data: {
					"keywords": "{{ keywords }}",
					"min_price": {{ min_price }},
					"max_price": {{ max_price }}
				},
				dataType: 'JSON',
				success: function(response){

					var count = parseInt($('#count').text().trim(), 10);
					var new_count = count + response.ebayNumResults;
					$('#count').text(new_count);

					if (response.ebayNumResults > 0) {
						$('#eBay').append($("<h1></h1>").text("eBay Results:"));

						for (i = 0; i < response.ebayListings.length; i++) {
							var listing = response.ebayListings[i];

							var title = $("<p></p>").text(listing.title);
							var price = $("<p></p>").text(listing.price);
							if (listing.description != []) {
								description = $("<p></p>").text(listing.description);
							};
							var link = $("<a></a>").attr("href", listing.url).text("URL");

							$('#eBay').append(title, price, description, link);
						};
					} else {
						$('#eBay').append($("<h1></h1>").text("No results found on eBay"));
					};
				}
			}
		);
	}

	getMinfindResults();
	getEbayResults();
	getEtsyResults();

	function addToFavorite(evt){
		if ({{ user_id }} == 0){
			alert("Please log in first!");
		} else {
			origin_id_string = $(evt.currentTarget).attr("value");
			origin_id_array = origin_id_string.split(",");
			var listing_origin = origin_id_array[0];
			var listing_id = parseInt(origin_id_array[1], 10);

			$.ajax(
				{
					type: 'GET',
					url: '/add_to_favorites',
					data: {
						"user_id": {{ user_id }},
						"listing_origin": listing_origin,
						"listing_id": listing_id
					},
					dataType: "text",
					success: function(response){
						alert(response);
					}
				}
			);

		};
	};

	$('.favorite').on('click', addToFavorite);
</script>

{% endblock %}